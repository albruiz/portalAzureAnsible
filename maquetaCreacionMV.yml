- name: CREATE VM PLAYBOOK
    hosts: localhost
    connection: local
    gather_facts: False
    vars:
        dnsname: 'mvDesdeArchivo1.westeurope.cloudapp.azure.com'
        ip: "{{ lookup('dig', '{{ dnsname }}') }}"
    
    tasks:
    - debug:  msg="Public DNS name {{ dnsname }} resolved to IP {{ ip }}."

    # The following check is disabled so that the playbook does not stop upon existence of DNS name. Otherwise
    # it cannot be re-run after VM creation
    #  - name: Check if DNS is taken
    #    fail: msg="That DNS name seems to be already taken"
    #    when: ip != 'NXDOMAIN'
    
    ## Preguntar a ruben por el check de arriba, que está quitado por si el DNS está cogido, yo diría que para la primera version no se toca,
            

    - name: Create storage account
    azure_rm_storageaccount: ## Creamos un almacenamiento donde iran tanto la MV como el resourceGroup 
      resource_group: 'grupoArchivo1'
      name: 'mvDesdeArchivo1' ## NO LE CAMBIAMOS EL NOMBRE Y LUEGO LO USAREMOS, LUEGO ES LO OPTIMO?
      account_type: Standard_LRS ## Almacenamiento local en tu region (hay varios) Premium_LRS Standard_GRS Standard_LRS Standard_RAGRS Standard_ZRS Premium_ZRS: https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview
  - name: Create security group that allows SSH and HTTP #firewall además de trabajar con ACL 
    azure_rm_securitygroup: 
      resource_group: 'grupoArchivo1'
      name: 'mvDesdeArchivo1' ## POSTERIORMENTE SE USA ESTE NOMBRE COMO NOMBRE DE LA IP Y EN LA CREACION DE UN NIC -> PREGUNTAR A RUBEN SI ES LO OPTIMO
      rules: 
        - name: SSH  ## TIPO DE ACCESO SSH
          protocol: Tcp 
          destination_port_range: 22  
          access: Allow  
          priority: 101 
          direction: Inbound
        - name: WEB ## TIPO DE ACCESO TCP
          protocol: Tcp
          destination_port_range: 80  
          access: Allow  
          priority: 102 
          direction: Inbound
  - name: Create public IP address ## Crear una ip publica para poder conectar con la MV
    azure_rm_publicipaddress: 
      resource_group: 'grupoArchivo1'
      allocation_method: Static 
      name: 'mvDesdeArchivo1'
      domain_name_label: 'mvDesdeArchivo1'
  - name: Create NIC ## Crear una interfaz de red
    azure_rm_networkinterface:
      resource_group: 'grupoArchivo1'
      name: 'mvDesdeArchivo1'
      virtual_network_name: 'vnetArchivo1'
      subnet_name: 'subnetArchivo1'
      public_ip_name: 'mvDesdeArchivo1' ## SE LLAMAN ASI PORQUE NO LES HEMOS DADO ANTERIORMENTE UN NOMBRE DISTITNO AL DE LA MV
      security_group: 'mvDesdeArchivo1' ## SE LLAMAN ASI PORQUE NO LES HEMOS DADO ANTERIORMENTE UN NOMBRE DISTITNO AL DE LA MV
  - name: Create VM
    azure_rm_virtualmachine:
      resource_group: 'grupoArchivo1'
      name: 'mvDesdeArchivo1'
      storage_account: 'mvDesdeArchivo1'
      storage_container: 'mvDesdeArchivo1'
      storage_blob: 'mvDesdeArchivo1.vhd' ## ALMACENAMIENTO DEL SO
      network_interfaces: 'mvDesdeArchivo1'
      vm_size: Standard_D2s_v3 ## tipos de máquinas cpus y ram. https://docs.microsoft.com/en-us/azure/cloud-services/cloud-services-sizes-specs
      admin_username: usuario1 ## ESTE NOMBRE DE USUARIO VARIARA DEPENDIENDO DE LOS USUARIOS QUE POR PETICIÓN QUIERAN UNA MV
      admin_password: PASS
      ## ssh_password_enabled: false ## indica que no tiene contraseña por ssh con el usuario
      ## En este caso esto de aqui lo comento porque en el caso de que no tenga una contraseña el que es el super user tendrá que usar el sistema de claves, en este caso vamos a probar con darle una contraseña al usuario
      ## ssh_public_keys: ## SISTEMA DE CLAVES
      ##   - path: /home/azureuser/.ssh/authorized_keys
      ##     key_data: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSoEkmF9egL4K77zixpUDxPfqQcdzEOP/NG5XpErxBpiAO/b4h36YSK7MDWZqqabjLQSXLxolkx10colatEs1HPy+9oRquGz4aaB34MQ4t5mS286UDWi3knJICsU1XkzlrQFkpganZobtZfOtEYHy1FBGiUtOKuLyNynDzU/XzdfFjM1BXvAZ4LphWGZYweJHlUiQzghMVTqIXmYGAHKWnpF9+Z5GMNsfWhHFay+kI4rdgJClAY3wbMH3uiGGVEKAF6WdOzTY/Xnu50KZI61SUQaJ2Jbxf4BjG/DvVa8VIO6uvTRs09iOgSsr5cJ15dR2SciPChURnxJoppjTnMY59 azureuser@gruporecursos2mv1'
      image: ## SO de la MV
        offer: CentOS
        publisher: OpenLogic
        sku: '7.2'
        version: latest
        